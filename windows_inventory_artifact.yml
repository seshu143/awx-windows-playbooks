---
- name: Windows Inventory CSV and Push to GitHub
  hosts: all
  gather_facts: no

  vars:
    csv_file: windows_inventory.csv

  tasks:
    - name: Collect Windows OS details
      ansible.windows.win_shell: |
        $os = Get-CimInstance Win32_OperatingSystem
        "$($env:COMPUTERNAME),$($os.Caption),$($os.Version),$($os.BuildNumber)"
      register: win_os

    - name: Create CSV header (once)
      copy:
        dest: "{{ playbook_dir }}/{{ csv_file }}"
        content: "hostname,os_name,os_version,os_build\n"
      run_once: true
      delegate_to: localhost

    - name: Append CSV data
      lineinfile:
        path: "{{ playbook_dir }}/{{ csv_file }}"
        line: "{{ win_os.stdout }}"
      delegate_to: localhost

- name: Commit and Push CSV to GitHub
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Git add
      command: git add windows_inventory.csv
      args:
        chdir: "{{ playbook_dir }}"

    - name: Git commit
      command: git commit -m "Update Windows inventory CSV"
      args:
        chdir: "{{ playbook_dir }}"
      ignore_errors: yes

    - name: Git push
      command: git push
      args:
        chdir: "{{ playbook_dir }}"
